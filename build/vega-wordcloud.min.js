!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-util"),require("vega-dataflow"),require("vega-scale"),require("vega-statistics")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-scale","vega-statistics"],e):e((t.vega=t.vega||{},t.vega.transforms=t.vega.transforms||{}),t.vega,t.vega,t.vega,t.vega)}(this,function(t,e,n,r,a){"use strict";function i(t,e,n,r){if(!e.sprite){var a=t.context,i=t.ratio;a.clearRect(0,0,(g<<5)/i,m/i);var o,f,u,s,l,y=0,c=0,d=0,x=n.length;for(--r;++r<x;){if(e=n[r],a.save(),a.font=e.style+" "+e.weight+" "+~~((e.size+1)/i)+"px "+e.font,o=a.measureText(e.text+"m").width*i,u=e.size<<1,e.rotate){var v=Math.sin(e.rotate*h),p=Math.cos(e.rotate*h),b=o*p,w=o*v,z=u*p,M=u*v;o=Math.max(Math.abs(b+M),Math.abs(b-M))+31>>5<<5,u=~~Math.max(Math.abs(w+z),Math.abs(w-z))}else o=o+31>>5<<5;if(u>d&&(d=u),y+o>=g<<5&&(y=0,c+=d,d=0),c+u>=m)break;a.translate((y+(o>>1))/i,(c+(u>>1))/i),e.rotate&&a.rotate(e.rotate*h),a.fillText(e.text,0,0),e.padding&&(a.lineWidth=2*e.padding,a.strokeText(e.text,0,0)),a.restore(),e.width=o,e.height=u,e.xoff=y,e.yoff=c,e.x1=o>>1,e.y1=u>>1,e.x0=-e.x1,e.y0=-e.y1,e.hasText=!0,y+=o}for(var S=a.getImageData(0,0,(g<<5)/i,m/i).data,q=[];--r>=0;)if((e=n[r]).hasText){for(f=(o=e.width)>>5,u=e.y1-e.y0,s=0;s<u*f;s++)q[s]=0;if(null==(y=e.xoff))return;c=e.yoff;var T=0,W=-1;for(l=0;l<u;l++){for(s=0;s<o;s++){var R=f*l+(s>>5),k=S[(c+l)*(g<<5)+(y+s)<<2]?1<<31-s%32:0;q[R]|=k,T|=k}T?W=l:(e.y0++,u--,l--,c++)}e.y1=e.y0+W,e.sprite=q.slice(0,(e.y1-e.y0)*f)}}}function o(t,e,n){n>>=5;for(var r,a=t.sprite,i=t.width>>5,o=t.x-(i<<4),f=127&o,u=32-f,s=t.y1-t.y0,l=(t.y+t.y0)*n+(o>>5),y=0;y<s;y++){r=0;for(var c=0;c<=i;c++)if((r<<u|(c<i?(r=a[y*i+c])>>>f:0))&e[l+c])return!0;l+=n}return!1}function f(t,e){var n=t[0],r=t[1];e.x+e.x0<n.x&&(n.x=e.x+e.x0),e.y+e.y0<n.y&&(n.y=e.y+e.y0),e.x+e.x1>r.x&&(r.x=e.x+e.x1),e.y+e.y1>r.y&&(r.y=e.y+e.y1)}function u(t,e){return t.x+t.x1>e[0].x&&t.x+t.x0<e[1].x&&t.y+t.y1>e[0].y&&t.y+t.y0<e[1].y}function s(t){var e=t[0]/t[1];return function(t){return[e*(t*=.1)*Math.cos(t),t*Math.sin(t)]}}function l(t){for(var e=[],n=-1;++n<t;)e[n]=0;return e}function y(){try{var t="undefined"!=typeof document&&document.createElement?document.createElement("canvas"):0;if(t&&t.getContext)return t;try{return new(require("canvas"))}catch(t){e.error("Canvas unavailable. Run in browser or install node-canvas.")}}catch(t){e.error("Canvas unavailable. Run in browser or install node-canvas.")}}function c(t){return"function"==typeof t?t:function(){return t}}function d(t){n.Transform.call(this,v(),t)}function x(t,e){for(var n,r=1/0,a=-1/0,i=0,o=e.length;i<o;++i)(n=t(e[i]))<r&&(r=n),n>a&&(a=n);return[r,a]}var h=Math.PI/180,g=64,m=2048,v=function(){function t(t){t.width=t.height=1;var e=Math.sqrt(t.getContext("2d").getImageData(0,0,1,1).data.length>>2);t.width=(g<<5)/e,t.height=m/e;var n=t.getContext("2d");return n.fillStyle=n.strokeStyle="red",n.textAlign="center",{context:n,ratio:e}}function e(t,e,n){for(var r,a,i,f=e.x,s=e.y,l=Math.sqrt(b[0]*b[0]+b[1]*b[1]),y=w(b),c=M()<.5?1:-1,d=-c;(r=y(d+=c))&&(a=~~r[0],i=~~r[1],!(Math.min(Math.abs(a),Math.abs(i))>=l));)if(e.x=f+a,e.y=s+i,!(e.x+e.x0<0||e.y+e.y0<0||e.x+e.x1>b[0]||e.y+e.y1>b[1])&&(!n||!o(e,t,b[0]))&&(!n||u(e,n))){for(var x,h=e.sprite,g=e.width>>5,m=b[0]>>5,v=e.x-(g<<4),p=127&v,z=32-p,S=e.y1-e.y0,q=(e.y+e.y0)*m+(v>>5),T=0;T<S;T++){x=0;for(var W=0;W<=g;W++)t[q+W]|=x<<z|(W<g?(x=h[T*g+W])>>>p:0);q+=m}return e.sprite=null,!0}return!1}var n,r,a,d,x,h,v,b=[256,256],w=s,z=[],M=Math.random,S={},q=y;return S.layout=function(){for(var o=t(q()),u=l((b[0]>>5)*b[1]),s=null,y=z.length,c=-1,g=[],m=z.map(function(t){return{text:n(t),font:r(t),style:d(t),weight:x(t),rotate:h(t),size:~~a(t),padding:v(t),xoff:0,yoff:0,x1:0,y1:0,x0:0,y0:0,hasText:!1,sprite:null,datum:t}}).sort(function(t,e){return e.size-t.size});++c<y;){var p=m[c];p.x=b[0]*(M()+.5)>>1,p.y=b[1]*(M()+.5)>>1,i(o,p,m,c),p.hasText&&e(u,p,s)&&(g.push(p),s?f(s,p):s=[{x:p.x+p.x0,y:p.y+p.y0},{x:p.x+p.x1,y:p.y+p.y1}],p.x-=b[0]>>1,p.y-=b[1]>>1)}return g},S.words=function(t){return arguments.length?(z=t,S):z},S.size=function(t){return arguments.length?(b=[+t[0],+t[1]],S):b},S.font=function(t){return arguments.length?(r=c(t),S):r},S.fontStyle=function(t){return arguments.length?(d=c(t),S):d},S.fontWeight=function(t){return arguments.length?(x=c(t),S):x},S.rotate=function(t){return arguments.length?(h=c(t),S):h},S.text=function(t){return arguments.length?(n=c(t),S):n},S.spiral=function(t){return arguments.length?(w=p[t]||t,S):w},S.fontSize=function(t){return arguments.length?(a=c(t),S):a},S.padding=function(t){return arguments.length?(v=c(t),S):v},S.random=function(t){return arguments.length?(M=t,S):M},S},p={archimedean:s,rectangular:function(t){var e=4*t[0]/t[1],n=0,r=0;return function(t){var a=t<0?-1:1;switch(Math.sqrt(1+4*a*t)-a&3){case 0:n+=e;break;case 1:r+=4;break;case 2:n-=e;break;default:r-=4}return[n,r]}}},b=["x","y","font","fontSize","fontStyle","fontWeight","angle"],w=["text","font","rotate","fontSize","fontStyle","fontWeight"];d.Definition={type:"Wordcloud",metadata:{modifies:!0},params:[{name:"size",type:"number",array:!0,length:2},{name:"font",type:"string",expr:!0,default:"sans-serif"},{name:"fontStyle",type:"string",expr:!0,default:"normal"},{name:"fontWeight",type:"string",expr:!0,default:"normal"},{name:"fontSize",type:"number",expr:!0,default:14},{name:"fontSizeRange",type:"number",array:"nullable",default:[10,50]},{name:"rotate",type:"number",expr:!0,default:0},{name:"text",type:"field"},{name:"spiral",type:"string",values:["archimedean","rectangular"]},{name:"padding",type:"number",expr:!0},{name:"as",type:"string",array:!0,length:7,default:b}]},e.inherits(d,n.Transform).transform=function(t,n){var i=t.modified();if(i||n.changed(n.ADD_REM)||w.some(function(r){var a=t[r];return e.isFunction(a)&&n.modified(a.fields)})){var o,f=n.materialize(n.SOURCE).source,u=this.value,s=t.as||b,l=t.fontSize||14;if(e.isFunction(l)?o=t.fontSizeRange:l=e.constant(l),o){var y=l,c=r.scale("sqrt")().domain(x(y,f)).range(o);l=function(t){return c(y(t))}}f.forEach(function(t){t[s[0]]=NaN,t[s[1]]=NaN,t[s[3]]=0});for(var d,h,g=u.words(f).text(t.text).size(t.size||[500,500]).padding(t.padding||1).spiral(t.spiral||"archimedean").rotate(t.rotate||0).font(t.font||"sans-serif").fontStyle(t.fontStyle||"normal").fontWeight(t.fontWeight||"normal").fontSize(l).random(a.random).layout(),m=u.size(),v=m[0]>>1,p=m[1]>>1,z=0,M=g.length;z<M;++z)(h=(d=g[z]).datum)[s[0]]=d.x+v,h[s[1]]=d.y+p,h[s[2]]=d.font,h[s[3]]=d.size,h[s[4]]=d.style,h[s[5]]=d.weight,h[s[6]]=d.rotate;return n.reflow(i).modifies(s)}},t.wordcloud=d,Object.defineProperty(t,"__esModule",{value:!0})});